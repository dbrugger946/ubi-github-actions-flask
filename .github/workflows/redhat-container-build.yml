name: Build ubi-flask container
on:
  - push

env:
  IMAGE_REGISTRY: quay.io/dbrugger946
  IMAGE_NAME: ubi-github-actions-flask

jobs:
  build:
    name: Build image
    runs-on: ubuntu-latest

    steps:

      - name: Print variables and secrets
        run: | 
          echo "env.QUAY_USER ${{ vars.QUAY_USER }}"
          echo "secrets.QUAY_REGISTRY_PASSWORD ${{ secrets.QUAY_REGISTRY_PASSWORD }} "
      

      - name: Clone the repository
        uses: actions/checkout@v4

      - name: Buildah Action
        id: build-image
        uses: redhat-actions/buildah-build@v2
        with:
          image: ${{ env.IMAGE_NAME }}
          tags: latest ${{ github.sha }}
          containerfiles: |
            ./Dockerfile.RedHat

    # Podman Login action (https://github.com/redhat-actions/podman-login) also be used to log in,
    # in which case 'username' and 'password' can be omitted.

      - name: Push To quay.io
        id: push-to-quay
        uses: redhat-actions/push-to-registry@v2
        with:
          image: ${{ steps.build-image.outputs.image }}
          tags: ${{ steps.build-image.outputs.tags }}
          registry: ${{ env.IMAGE_REGISTRY }}
          username: dbrugger
          # password: El1zab3th
          # username: ${{ vars.QUAY_USER }}
          password: ${{ secrets.QUAY_REGISTRY_PASSWORD }}
  
      - name: Print image url
        run: echo "Image pushed to ${{ steps.push-to-quay.outputs.registry-paths }}"
